{
  "id": "Stage1-api-003",
  "contract_name": "Chat Streaming and Messages API",
  "version": "1.0.0",
  "base_url": "http://localhost:8000/api",
  "description": "API contract for SSE streaming chat and message operations",

  "endpoints": [
    {
      "name": "Stream Chat (SSE)",
      "method": "POST",
      "path": "/chat/stream",
      "description": "Initiate LLM chat stream using Server-Sent Events",

      "request": {
        "content_type": "application/json",
        "body_schema": {
          "conversation_id": {
            "type": "integer",
            "required": true,
            "description": "Conversation to add message to"
          },
          "message": {
            "type": "string",
            "required": true,
            "max_length": 10000,
            "description": "User message content"
          }
        },
        "example": {
          "conversation_id": 1,
          "message": "Explain IEC 62443-4-2 CR 2.11"
        }
      },

      "responses": {
        "200": {
          "description": "SSE stream initiated",
          "content_type": "text/event-stream",
          "headers": {
            "Content-Type": "text/event-stream",
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "X-Accel-Buffering": "no",
            "X-Session-ID": "UUID string for stream session (used for cancellation)"
          },
          "session_management": {
            "session_id_generation": "import uuid; session_id = str(uuid.uuid4())",
            "session_id_location": "Returned in X-Session-ID header",
            "usage": "Client stores session_id to enable stream cancellation via POST /chat/cancel/{session_id}"
          },

          "event_types": {
            "token": {
              "description": "Individual LLM token",
              "data_schema": {
                "token": "string",
                "message_id": "integer",
                "session_id": "string (UUID)"
              },
              "example": "data: {\"token\": \"The\", \"message_id\": 42, \"session_id\": \"550e8400-e29b-41d4-a716-446655440000\"}\\n\\n"
            },
            "complete": {
              "description": "Stream completed successfully",
              "data_schema": {
                "message_id": "integer",
                "token_count": "integer",
                "completion_time_ms": "integer"
              },
              "example": "data: {\"message_id\": 42, \"token_count\": 150, \"completion_time_ms\": 3500}\\n\\n"
            },
            "error": {
              "description": "Error during streaming",
              "data_schema": {
                "error": "string",
                "error_type": "string"
              },
              "example": "data: {\"error\": \"LLM service unavailable\", \"error_type\": \"service_error\"}\\n\\n"
            }
          },

          "notes": [
            "Use EventSource API on client side",
            "Events sent as 'data: {json}\\n\\n'",
            "Connection auto-reconnects on disconnect (EventSource built-in)",
            "Keep-alive: Server sends comment (:ping\\n\\n) every 30s"
          ]
        },
        "400": {
          "description": "Validation error",
          "content_type": "application/json",
          "schema": {"detail": "string"}
        },
        "404": {
          "description": "Conversation not found",
          "content_type": "application/json"
        },
        "503": {
          "description": "LLM service unavailable",
          "content_type": "application/json"
        }
      },

      "sse_specification": {
        "protocol": "Server-Sent Events (SSE)",
        "event_format": "data: {JSON}\\n\\n",
        "reconnection": "Automatic via EventSource",
        "timeout": "Browser default (30s typically)",
        "keep_alive_interval": "30 seconds (comment line)",
        "connection_limit": "6 per domain (browser limit)"
      }
    },

    {
      "name": "Cancel Stream",
      "method": "POST",
      "path": "/chat/cancel/{session_id}",
      "description": "Cancel an ongoing SSE stream",

      "request": {
        "path_parameters": {
          "session_id": {
            "type": "string (UUID)",
            "description": "Session ID from stream initiation"
          }
        }
      },

      "responses": {
        "200": {
          "description": "Stream cancelled",
          "schema": {"status": "string"},
          "example": {"status": "cancelled"}
        },
        "404": {
          "description": "Session not found (already complete or invalid)"
        }
      }
    },

    {
      "name": "Get Messages",
      "method": "GET",
      "path": "/messages/{conversation_id}",
      "description": "Retrieve messages for a conversation",

      "request": {
        "path_parameters": {
          "conversation_id": {"type": "integer"}
        },
        "query_parameters": {
          "limit": {"type": "integer", "default": 50, "max": 100},
          "offset": {"type": "integer", "default": 0}
        }
      },

      "responses": {
        "200": {
          "schema": {
            "messages": "array",
            "total_count": "integer"
          },
          "example": {
            "messages": [
              {
                "id": 1,
                "conversation_id": 1,
                "role": "user",
                "content": "Explain IEC 62443",
                "created_at": "2025-11-17T10:00:00Z",
                "reaction": null,
                "token_count": 10
              },
              {
                "id": 2,
                "conversation_id": 1,
                "role": "assistant",
                "content": "IEC 62443 is...",
                "created_at": "2025-11-17T10:00:05Z",
                "reaction": "thumbs_up",
                "token_count": 150,
                "model_name": "gpt-oss-20b",
                "completion_time_ms": 3500
              }
            ],
            "total_count": 2
          }
        }
      }
    },

    {
      "name": "Add Message Reaction",
      "method": "POST",
      "path": "/messages/{id}/reaction",
      "description": "Add or update message reaction",

      "request": {
        "path_parameters": {
          "id": {"type": "integer", "description": "Message ID"}
        },
        "body_schema": {
          "reaction": {
            "type": "string|null",
            "enum": ["thumbs_up", "thumbs_down", null],
            "description": "Reaction type (null removes reaction)"
          }
        },
        "example": {"reaction": "thumbs_up"}
      },

      "responses": {
        "200": {
          "schema": {
            "message_id": "integer",
            "reaction": "string|null"
          },
          "example": {
            "message_id": 2,
            "reaction": "thumbs_up"
          }
        }
      }
    },

    {
      "name": "Regenerate Response",
      "method": "POST",
      "path": "/messages/{id}/regenerate",
      "description": "Regenerate assistant response (creates new message with same parent)",

      "request": {
        "path_parameters": {
          "id": {"type": "integer", "description": "User message ID to regenerate response for"}
        }
      },

      "responses": {
        "200": {
          "description": "Regeneration initiated (returns SSE stream)",
          "content_type": "text/event-stream",
          "notes": "Same SSE format as /chat/stream"
        },
        "404": {
          "description": "Message not found or not a user message"
        }
      }
    },

    {
      "name": "Health Check",
      "method": "GET",
      "path": "/health",
      "description": "Service health check",

      "responses": {
        "200": {
          "schema": {
            "status": "string",
            "llm_service": "string",
            "database": "string"
          },
          "example": {
            "status": "healthy",
            "llm_service": "connected",
            "database": "connected"
          }
        }
      }
    }
  ],

  "data_models": {
    "Message": {
      "id": "integer (primary key)",
      "conversation_id": "integer (foreign key)",
      "role": "string (user|assistant)",
      "content": "text",
      "created_at": "datetime",
      "reaction": "string (nullable) - thumbs_up|thumbs_down",
      "parent_message_id": "integer (nullable, foreign key)",
      "token_count": "integer",
      "model_name": "string",
      "completion_time_ms": "integer (nullable)",
      "metadata": "JSON object"
    }
  },

  "client_integration": {
    "sse_client_example": "const eventSource = new EventSource('/api/chat/stream?conversation_id=1&message=Hello');",
    "event_listeners": ["message", "error", "open"],
    "reconnection": "Automatic (EventSource built-in)",
    "cleanup": "eventSource.close() on component unmount or cancel"
  },

  "error_handling": {
    "llm_timeout": "Return error event via SSE after 60s",
    "llm_unavailable": "Return 503 or error event",
    "connection_lost": "EventSource auto-reconnects",
    "invalid_input": "Return 400 before streaming"
  }
}
